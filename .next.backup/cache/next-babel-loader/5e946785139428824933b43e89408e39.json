{"ast":null,"code":"import React from \"react\";\nvar __jsx = React.createElement;\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nimport { FormControl, FormLabel, FormHelperText, Input, Stack, Tabs, TabList, TabPanels, Tab, TabPanel, Box, Flex, RadioGroup, Radio, Textarea, Button, ButtonGroup, Text } from '@chakra-ui/core';\nimport Loader from 'react-loader';\nimport { useWeb3React } from '@web3-react/core';\nimport { useEffect, useState } from 'react';\nimport { TransactionToast } from './TransactionToast';\nimport { EMBLEM_API, contractAddresses } from '../constants';\nimport { Notify } from './Notify';\nimport { useContract } from '../hooks';\nexport default function Create(props) {\n  const {\n    0: tabIndex,\n    1: setTabIndex\n  } = useState(0);\n  const {\n    account,\n    chainId\n  } = useWeb3React();\n  const {\n    0: vaultAddress,\n    1: setVaultAddress\n  } = useState(account || '');\n  const {\n    0: vaultPubPriv,\n    1: setVaultPubPriv\n  } = useState('Public');\n  const {\n    0: vaultName,\n    1: setVaultName\n  } = useState('');\n  const {\n    0: vaultDesc,\n    1: setVaultDesc\n  } = useState('');\n  const {\n    0: vaultImage,\n    1: setVaultImage\n  } = useState('');\n  const {\n    0: password,\n    1: setPassword\n  } = useState('');\n  const {\n    0: service,\n    1: setService\n  } = useState('');\n  const {\n    0: isCovalApproved,\n    1: setIsCovalApproved\n  } = useState(false);\n  const {\n    0: state,\n    1: setState\n  } = useState({\n    loaded: true,\n    private: false\n  });\n  const {\n    0: hash,\n    1: setHash\n  } = useState(null);\n  const {\n    0: tokenId,\n    1: setTokenId\n  } = useState(null);\n  const {\n    0: mintPassword,\n    1: setMintPassword\n  } = useState(null);\n  const {\n    0: showNotify,\n    1: setShowNotify\n  } = useState(false);\n  const {\n    0: decimals,\n    1: setDecimals\n  } = useState(null);\n  const {\n    0: allowance,\n    1: setAllowance\n  } = useState(null);\n  const {\n    0: balance,\n    1: setBalance\n  } = useState(null);\n  const {\n    0: price,\n    1: setPrice\n  } = useState(null);\n  const {\n    0: creating,\n    1: setCreating\n  } = useState(false);\n  const handlerContract = useContract(contractAddresses.vaultHandler[chainId], contractAddresses.vaultHandlerAbi, true);\n  const covalContract = useContract(contractAddresses.coval[chainId], contractAddresses.covalAbi, true);\n\n  const getContractStates = async () => {\n    setDecimals(await covalContract.decimals());\n    setAllowance(await covalContract.allowance(account, contractAddresses.vaultHandler[chainId]).then(balance => balance.toString()));\n    setBalance(await covalContract.balanceOf(account).then(balance => balance.toString()));\n    setPrice(await handlerContract.price().then(balance => balance.toString()));\n    console.log('balance', balance, 'allowance', allowance, 'price', price, Number(allowance) >= Number(price));\n\n    if (Number(allowance) >= Number(price)) {\n      setIsCovalApproved(true);\n    } else {\n      setIsCovalApproved(false);\n    }\n  };\n\n  const fireMetaMask = () => {\n    ;\n    handlerContract.buyWithPaymentOnly(vaultAddress, tokenId, mintPassword).then(({\n      hash\n    }) => {\n      setCreating(true);\n      setTimeout(() => {\n        setHash(hash);\n      }, 100); // Solving State race condition where transaction watcher wouldn't notice we were creating\n    }).catch(error => {\n      if ((error === null || error === void 0 ? void 0 : error.code) !== 4001) {\n        console.log(`tx failed.`, error);\n      }\n    });\n  };\n\n  const approveCovalFlow = () => {\n    ;\n    covalContract.approve(contractAddresses.vaultHandler[chainId], '100000000000000').then(({\n      hash\n    }) => {\n      setHash(hash);\n    });\n  };\n\n  const handleSubmit = evt => {\n    evt.preventDefault();\n    setState({\n      loaded: false,\n      private: state.private\n    });\n    fetch(EMBLEM_API + '/mint', {\n      method: 'POST',\n      headers: {\n        Authorization: 'Basic YWRtaW46c3VwZXJzZWNyZXQ=',\n        'Content-Type': 'application/json',\n        service: service\n      },\n      // We convert the React state to JSON and send it as the POST body\n      body: JSON.stringify({\n        fromAddress: account,\n        toAddress: vaultAddress,\n        description: vaultDesc,\n        name: vaultName,\n        image: vaultImage,\n        chainId: chainId,\n        private: state.private,\n        password: password || ''\n      })\n    }).then(async function (response) {\n      setState({\n        loaded: true,\n        private: state.private\n      });\n      let body = await response.json();\n      setHash(body.data.tx);\n      setTokenId(body.data.tokenId);\n      setMintPassword(body.password);\n      setShowNotify(true);\n    });\n  };\n\n  function previewFile() {\n    const preview = document.querySelector('img');\n    const inputelement = document.querySelector('input[type=file]'); //.files[0];\n\n    const reader = new FileReader();\n    reader.addEventListener('load', function () {\n      var _reader$result;\n\n      // convert image file to base64 string\n      if (preview) preview.src = ((_reader$result = reader.result) === null || _reader$result === void 0 ? void 0 : _reader$result.toString()) || '';\n      if (preview) setVaultImage(preview.src);\n    }, false);\n\n    if (inputelement.files) {\n      reader.readAsDataURL(inputelement.files[0]);\n    }\n  }\n\n  const {\n    0: acct,\n    1: setAcct\n  } = useState('');\n  useEffect(() => {\n    if (account && acct != account) {\n      setAcct(account);\n      setVaultAddress(account);\n    }\n  }, [account, acct]);\n  useEffect(() => {\n    account && chainId ? getContractStates() : null;\n  });\n  return __jsx(Loader, {\n    loaded: state.loaded\n  }, __jsx(Flex, {\n    width: \"full\",\n    align: \"center\",\n    justifyContent: \"center\"\n  }, __jsx(Box, {\n    maxW: \"sm\",\n    borderWidth: \"1px\",\n    rounded: \"lg\",\n    overflow: \"hidden\"\n  }, __jsx(Tabs, {\n    defaultIndex: 0,\n    index: tabIndex,\n    onChange: index => setTabIndex(index)\n  }, __jsx(TabList, null, __jsx(Tab, null, \"Make\"), __jsx(Tab, null, \"My\"), __jsx(Tab, null, \"Vault\")), __jsx(TabPanels, null, __jsx(TabPanel, null, __jsx(Stack, {\n    direction: \"column\",\n    align: \"center\",\n    spacing: \"2rem\",\n    flexGrow: 1,\n    justifyContent: \"center\",\n    px: \"2rem\",\n    py: \"2rem\",\n    shouldWrapChildren: true\n  }, __jsx(Stack, {\n    direction: \"row\",\n    align: \"flex-start\",\n    spacing: \"0rem\",\n    flexWrap: \"wrap\",\n    shouldWrapChildren: true\n  }, __jsx(FormControl, {\n    isRequired: true\n  }, __jsx(FormLabel, {\n    htmlFor: \"owner-address\"\n  }, \"Vault Owner Address\"), __jsx(Input, {\n    type: \"text\",\n    id: \"owner-address\",\n    \"aria-describedby\": \"owner-helper-text\",\n    placeholder: \"0xdeadbeef\",\n    value: vaultAddress,\n    onChange: e => setVaultAddress(e.target.value)\n  }), __jsx(FormHelperText, {\n    id: \"owner-helper-text\"\n  }, \"What is the address of the first owner of this vault? Pro tip: When you connect a web3 wallet, this will populate automagically with your address.\"))), __jsx(Stack, {\n    direction: \"row\",\n    align: \"flex-start\",\n    spacing: \"0rem\",\n    flexWrap: \"wrap\",\n    shouldWrapChildren: true\n  }, __jsx(FormControl, {\n    as: \"fieldset\",\n    isRequired: true\n  }, __jsx(FormLabel, null, \"Public or Private?\"), __jsx(RadioGroup, {\n    id: \"pubpriv\",\n    defaultValue: \"Public\",\n    onChange: e => {\n      setVaultPubPriv(e.target.value);\n      setState({\n        loaded: state.loaded,\n        private: e.target.value === 'Private'\n      });\n      console.log('Private', e.target.value === 'Private');\n    }\n  }, __jsx(Radio, {\n    value: \"Public\"\n  }, \"Public\"), __jsx(Radio, {\n    value: \"Private\"\n  }, \"Private\")), __jsx(FormHelperText, {\n    id: \"email-helper-text\"\n  }, \"Do you want people to be able to see the contents?\")), state.private ? __jsx(FormControl, null, __jsx(FormLabel, null, \"Password\"), __jsx(Input, {\n    type: \"password\",\n    id: \"vault-password\",\n    onChange: e => setPassword(e.target.value),\n    \"aria-describedby\": \"password-helper-text\"\n  }), __jsx(FormHelperText, {\n    id: \"password-helper-text\"\n  }, \"This password will be used to encrypt and decrypt the contents of this vault\")) : ''), __jsx(Stack, {\n    direction: \"row\",\n    align: \"flex-start\",\n    spacing: \"0rem\",\n    flexWrap: \"wrap\",\n    shouldWrapChildren: true\n  }, __jsx(Button, {\n    onClick: () => setTabIndex(1)\n  }, \"Next\")))), __jsx(TabPanel, null, __jsx(Stack, {\n    direction: \"column\",\n    align: \"center\",\n    spacing: \"2rem\",\n    flexGrow: 1,\n    justifyContent: \"center\",\n    px: \"2rem\",\n    py: \"2rem\",\n    shouldWrapChildren: true\n  }, __jsx(Stack, {\n    direction: \"row\",\n    align: \"flex-start\",\n    spacing: \"0rem\",\n    flexWrap: \"wrap\",\n    shouldWrapChildren: true\n  }, __jsx(FormControl, {\n    isRequired: true\n  }, __jsx(FormLabel, {\n    htmlFor: \"vault-name\"\n  }, \"Vault Name\"), __jsx(Input, {\n    type: \"text\",\n    id: \"vault-name\",\n    \"aria-describedby\": \"vault-name-text\",\n    value: vaultName,\n    onChange: e => setVaultName(e.target.value)\n  }), __jsx(FormHelperText, {\n    id: \"vault-name-text\"\n  }, \"Give it some love so you can find it later.\"))), __jsx(Stack, {\n    direction: \"row\",\n    align: \"flex-start\",\n    spacing: \"0rem\",\n    flexWrap: \"wrap\",\n    shouldWrapChildren: true\n  }, __jsx(FormControl, {\n    isRequired: true\n  }, __jsx(FormLabel, {\n    htmlFor: \"vault-desc\"\n  }, \"Vault Description\"), __jsx(Textarea, {\n    id: \"vault-desc\",\n    size: \"lg\",\n    \"aria-describedby\": \"vault-desc-text\",\n    value: vaultDesc,\n    onChange: e => setVaultDesc(e.target.value)\n  }), __jsx(FormHelperText, {\n    id: \"vault-desc-text\"\n  }, \"Add some fluffy text to tell people what the point is!\"))), __jsx(Stack, {\n    direction: \"row\",\n    align: \"flex-start\",\n    spacing: \"0rem\",\n    flexWrap: \"wrap\",\n    shouldWrapChildren: true\n  }, __jsx(ButtonGroup, {\n    spacing: 4\n  }, __jsx(Button, {\n    onClick: () => setTabIndex(0)\n  }, \"Back\"), __jsx(Button, {\n    onClick: () => setTabIndex(2)\n  }, \"Next\"))))), __jsx(TabPanel, null, __jsx(Stack, {\n    direction: \"column\",\n    align: \"center\",\n    spacing: \"2rem\",\n    flexGrow: 1,\n    justifyContent: \"center\",\n    px: \"2rem\",\n    py: \"2rem\",\n    shouldWrapChildren: true\n  }, __jsx(Stack, {\n    direction: \"row\",\n    align: \"flex-start\",\n    spacing: \"0rem\",\n    flexWrap: \"wrap\",\n    shouldWrapChildren: true\n  }, __jsx(FormControl, null, __jsx(FormLabel, {\n    htmlFor: \"vault-img\"\n  }, \"Vault Image\"), __jsx(Box, {\n    maxW: \"sm\",\n    borderWidth: \"1px\",\n    p: 1,\n    rounded: \"lg\",\n    overflow: \"hidden\"\n  }, __jsx(\"input\", {\n    type: \"file\",\n    onChange: () => previewFile()\n  }), __jsx(\"br\", null), __jsx(\"br\", null), __jsx(\"img\", {\n    src: \"\",\n    width: \"200\",\n    alt: \"Image preview...\"\n  })))), __jsx(Stack, {\n    direction: \"row\",\n    align: \"flex-start\",\n    spacing: \"0rem\",\n    flexWrap: \"wrap\",\n    shouldWrapChildren: true\n  }, __jsx(FormControl, null, __jsx(FormLabel, {\n    htmlFor: \"service\"\n  }, \"API password:\"), __jsx(Input, {\n    type: \"password\",\n    id: \"service\",\n    \"aria-describedby\": \"service\",\n    onChange: e => setService(e.target.value)\n  }))), isCovalApproved ? __jsx(Stack, {\n    direction: \"row\",\n    align: \"flex-start\",\n    spacing: \"0rem\",\n    flexWrap: \"wrap\",\n    shouldWrapChildren: true\n  }, __jsx(Box, {\n    maxW: \"sm\",\n    borderWidth: \"1px\",\n    p: 1,\n    rounded: \"lg\",\n    overflow: \"hidden\"\n  }, __jsx(Text, null, \"Creating a vault spends \", price * Math.pow(10, -decimals), \" Coval from your wallet\"))) : null, Number(balance) < Number(price) ? __jsx(Box, {\n    d: \"flex\",\n    alignItems: \"baseline\",\n    justifyContent: \"space-between\",\n    mt: \"2\"\n  }, __jsx(Button, _extends({\n    width: \"100%\",\n    as: \"a\"\n  }, {\n    href: location.origin + '/buy?chain=' + chainId + '&output=0x3D658390460295FB963f54dC0899cfb1c30776Df&input=0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2',\n    target: '_blank',\n    rel: 'noopener noreferrer'\n  }), \"Buy coval\")) : __jsx(Stack, {\n    direction: \"row\",\n    align: \"flex-start\",\n    spacing: \"0rem\",\n    flexWrap: \"wrap\",\n    shouldWrapChildren: true\n  }, __jsx(Box, {\n    maxW: \"sm\",\n    borderWidth: \"1px\",\n    p: 1,\n    rounded: \"lg\",\n    overflow: \"hidden\"\n  }, __jsx(Text, null, \"Circuits of Value Balance:\", ' ', account ? balance * Math.pow(10, -decimals) : '¯\\\\_(ツ)_/¯ No wallet connected'))), __jsx(Stack, {\n    direction: \"row\",\n    align: \"flex-start\",\n    spacing: \"0rem\",\n    flexWrap: \"wrap\",\n    shouldWrapChildren: true\n  }, __jsx(ButtonGroup, {\n    spacing: 4\n  }, __jsx(Button, {\n    onClick: () => setTabIndex(1)\n  }, \"Back\"), !account ? __jsx(Button, {\n    isDisabled: true,\n    type: \"submit\"\n  }, \"No Wallet Connected!\") : !vaultAddress || !vaultName || !vaultDesc ? __jsx(Button, {\n    isDisabled: true,\n    type: \"submit\"\n  }, \"Missing Fields!\") : !service ? __jsx(Button, {\n    isDisabled: true,\n    type: \"submit\"\n  }, \"Creation Password?\") : !isCovalApproved ? __jsx(Button, {\n    onClick: approveCovalFlow,\n    type: \"submit\"\n  }, \"Approve Coval\") : balance < price ? __jsx(Button, {\n    isDisabled: true,\n    type: \"submit\"\n  }, \"Insufficient Balance\") : __jsx(Button, {\n    onClick: handleSubmit,\n    type: \"submit\"\n  }, \"DO IT!\"))))))))), showNotify || hash ? __jsx(Stack, {\n    direction: \"column\",\n    align: \"left\",\n    shouldWrapChildren: true\n  }, showNotify ? __jsx(Notify, {\n    color: \"green\",\n    message: \"Asking the blockchain if it is willing to create your vault ...\",\n    onClose: () => {\n      setShowNotify(false);\n    }\n  }) : null, hash ? __jsx(TransactionToast, {\n    hash: hash,\n    onComplete: () => {\n      setHash(null);\n\n      if (!creating) {\n        fireMetaMask();\n      } else {\n        location.href = location.origin + '/vaultlist';\n      }\n    }\n  }) : null) : null);\n}","map":null,"metadata":{},"sourceType":"module"}